<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>SocketFlow Export</title>
</head>
<body class="min-h-screen bg-gray-50 flex relative">
  <div class="absolute top-4 right-6 flex items-center space-x-4 text-lg">
    <span id="username" class="font-semibold"></span>
    <a href="#" id="logout" class="text-red-600 hover:text-red-800">Logout</a>
  </div>
  <aside class="w-64 bg-white shadow-md">
    <div class="p-6 border-b">
      <h2 class="text-2xl font-semibold">SocketFlow</h2>
    </div>
    <nav class="p-4 space-y-2">
      <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-100">See All Devices</a>
      <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-100">Register Device</a>
      <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-100">Latest Data</a>
      <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-100">List Fields</a>
      <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-100">Field Records</a>
      <a href="charts.html"    class="block px-4 py-2 rounded hover:bg-gray-100">Charts</a>
      <span class="block px-4 py-2 rounded bg-gray-100 font-semibold">Export</span>
    </nav>
  </aside>

  <main class="flex-1 p-8 space-y-8 overflow-auto">
    <div class="max-w-xl mx-auto space-y-6">
      <h2 class="text-3xl font-bold">Export Device Data</h2>
      <select id="exportDevice" class="w-full px-4 py-2 border rounded"></select>
      <select id="exportFormat" class="w-full px-4 py-2 border rounded">
        <option value="pdf">PDF</option>
        <option value="csv">CSV</option>
        <option value="xlsx">Excel</option>
        <option value="json">JSON</option>
      </select>
      <div class="flex items-center space-x-4">
        <label class="inline-flex items-center">
          <input type="radio" name="timeFilter" value="all" checked class="form-radio"/>
          <span class="ml-2">All Time</span>
        </label>
        <label class="inline-flex items-center">
          <input type="radio" name="timeFilter" value="range" class="form-radio"/>
          <span class="ml-2">Date Range</span>
        </label>
      </div>
      <div id="rangeInputs" class="flex space-x-2 hidden">
        <input id="startDate" type="datetime-local" class="flex-1 px-4 py-2 border rounded"/>
        <input id="endDate"   type="datetime-local" class="flex-1 px-4 py-2 border rounded"/>
      </div>
      <button id="btnExport" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export</button>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const BASE = 'http://localhost';
      const logoutBtn = document.getElementById('logout');
      const userSpan  = document.getElementById('username');
      const auth      = sessionStorage.getItem('auth') || '';
      userSpan.textContent = atob(auth).split(':')[0] || '';
      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('auth');
        location.href = 'dashboard.html';
      });

      async function getAuthHeader() {
        const a = sessionStorage.getItem('auth');
        if (!a) throw new Error('Not authenticated');
        return { 'Authorization': `Basic ${a}` };
      }

      async function fetchJson(path) {
        const opts = { headers: await getAuthHeader() };
        const res = await fetch(BASE + path, opts);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      async function loadDevices() {
        const devices = await fetchJson('/api/device/all');
        document.getElementById('exportDevice').innerHTML =
          devices.map(d => `<option value="${d.accessToken}">${d.name}</option>`).join('');
      }

      document.getElementsByName('timeFilter').forEach(r => {
        r.addEventListener('change', () => {
          document.getElementById('rangeInputs')
            .classList.toggle('hidden', r.value !== 'range');
        });
      });

      document.getElementById('btnExport').addEventListener('click', async () => {
        const token  = document.getElementById('exportDevice').value;
        const format = document.getElementById('exportFormat').value;
        let path = `/api/export?format=${format}&accessToken=${token}`;
        if (document.querySelector('input[name="timeFilter"]:checked').value === 'range') {
          const start = document.getElementById('startDate').value;
          const end   = document.getElementById('endDate').value;
          if (start && end) {
            path += `&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
          }
        }
        const headers = await getAuthHeader();
        const res = await fetch(BASE + path, { headers });
        if (!res.ok) {
          alert('Export failed');
          return;
        }
        const blob = await res.blob();
        const ext  = format === 'xlsx' ? 'xlsx' : format;
        const deviceName = document.getElementById('exportDevice')
                              .selectedOptions[0].text.replace(/\s+/g, '_');
        const now = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `export_${deviceName}_${format}_${now}.${ext}`;
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      });

      loadDevices();
    });
  </script>
</body>
</html>
